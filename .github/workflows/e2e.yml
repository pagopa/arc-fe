name: e2e

on: [pull_request]

env:
  NODE_VERSION: '18.18.0'

jobs:
  testing-e2e:
    runs-on: ubuntu-latest
# unfortunately using environment implies a deployment
# this is a problem for us, read the following for more info
# https://github.com/actions/runner/issues/2120    
#    environment: ${{ github.base_ref == 'uat' && 'uat' || 'dev' }}
  
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Checkout fe code
        uses: actions/checkout@v4
        with:
          path: fe

      - name: populate environment vars using a specific .env.ENVIRONMENT FILE
        run: |
          rm .env
          mv .env.${{ github.base_ref == 'uat' && 'uat' || 'dev' }} .env
          echo VERSION=${{ github.sha }} >> .env
          cat .env
        working-directory: fe

#      - name: populate environment vars writing down an .env file
#        run: |
#          rm .env
#          touch .env
#          echo APIHOST=${{ vars.API_HOST }} >> .env
#          echo ENV=test >> .env
#          echo ENTITIES_LOGO_CDN=https://assets.cdn.io.italia.it/logos/organizations >> .env
#          echo CHECKOUT_HOST=${{ vars.CHECKOUT_HOST }} >> .env
#          echo LOGIN_URL=${{ vars.LOGIN_URL }} >> .env
#          echo CHECKOUT_PLATFORM_URL=${{ vars.CHECKOUT_PLATFORM_URL }} >> .env
#          echo PAYMENT_RETURN_URL=http://localhost:1234 >> .env
#          echo DEPLOY_PATH=/pagamenti >> .env
#          echo VERSION=${{ github.sha }} >> .env
#          cat .env
#        working-directory: fe
  
      - name: Install fe dependecies
        run: yarn install
        working-directory: fe
  
      - name: run fe
        run: yarn start &
        working-directory: fe

      - name: Checkout e2e repository
        uses: actions/checkout@v4
        with:
          repository: pagopa/arc-fe-e2e
          path: e2e

      - name: Install e2e dependecies
        run: yarn install
        working-directory: e2e
      
      - name: Install playwright browsers
        run: yarn playwright install
        working-directory: e2e

      - name: populate environment vars writing down an .env file
        run: |
          touch .env
          echo BASE_URL=http://localhost:1234 >> .env
          echo USERNAME=${{ secrets.E2E_USERNAME }} >> .env
          echo PASSWORD=${{ secrets.E2E_PASSWORD }} >> .env
          echo IDENTITY_PROVIDER_BUTTON_TEST_ID=idp-button-https://validator.dev.oneid.pagopa.it/demo >> .env
          cat .env
        working-directory: e2e

      - name: run e2e tests
        run: yarn test --project chromium
        working-directory: e2e
